<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>MainFragment.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">app</a> &gt; <a href="index.source.html" class="el_package">hos.houns.weatherapp.presentation</a> &gt; <span class="el_source">MainFragment.kt</span></div><h1>MainFragment.kt</h1><pre class="source lang-java linenums">package hos.houns.weatherapp.presentation

import android.Manifest
import android.annotation.SuppressLint
import android.app.*
import android.content.Intent
import android.content.pm.PackageManager
import android.os.Bundle
import android.provider.Settings
import androidx.fragment.app.Fragment
import android.view.LayoutInflater
import android.view.View
import android.view.ViewGroup
import androidx.lifecycle.lifecycleScope
import hos.houns.weatherapp.databinding.FragmentMainBinding
import kotlinx.coroutines.flow.collect
import org.koin.android.viewmodel.ext.android.getSharedViewModel
import android.util.Log
import androidx.core.content.ContextCompat
import androidx.recyclerview.widget.LinearLayoutManager
import hos.houns.weatherapp.R
import hos.houns.weatherapp.data.withDegree
import hos.houns.weatherapp.domain.core.Failure
import hos.houns.weatherapp.domain.entity.WeatherType
import hos.houns.weatherapp.domain.entity.WeatherUiModel
import hos.houns.weatherapp.presentation.favorite.PlaceAutocompleteActivity


<span class="nc" id="L29">class MainFragment : Fragment(R.layout.fragment_main) {</span>

    private var _binding: FragmentMainBinding? = null
<span class="nc" id="L32">    private val binding get() = _binding!!</span>
    private lateinit var viewModel: MainViewModel

    override fun onCreate(savedInstanceState: Bundle?) {
<span class="nc" id="L36">        super.onCreate(savedInstanceState)</span>
<span class="nc" id="L37">        initObservers()</span>
<span class="nc" id="L38">    }</span>

    override fun onCreateView(
        inflater: LayoutInflater, container: ViewGroup?,
        savedInstanceState: Bundle?
    ): View {
<span class="nc" id="L44">        _binding = FragmentMainBinding.inflate(inflater, container, false)</span>
<span class="nc" id="L45">        return binding.root</span>
    }

    override fun onViewCreated(view: View, savedInstanceState: Bundle?) {
<span class="nc" id="L49">        super.onViewCreated(view, savedInstanceState)</span>
<span class="nc" id="L50">        viewModel = getSharedViewModel()</span>

<span class="nc" id="L52">        println(requireActivity().intent.extras)</span>
<span class="nc bnc" id="L53" title="All 2 branches missed.">        if (requireActivity().intent.extras == null) {</span>
<span class="nc" id="L54">            binding.locations.visibility = View.VISIBLE</span>
<span class="nc" id="L55">            binding.back.visibility = View.GONE</span>
        } else {
<span class="nc" id="L57">            binding.locations.visibility = View.GONE</span>
<span class="nc" id="L58">            binding.back.visibility = View.VISIBLE</span>
<span class="nc" id="L59">            binding.back.setOnClickListener {</span>
<span class="nc bnc" id="L60" title="All 2 branches missed.">                activity?.finish()</span>
<span class="nc" id="L61">            }</span>

        }
<span class="nc" id="L64">        binding.locations.setOnClickListener {</span>
<span class="nc" id="L65">            startActivity(Intent(requireActivity(), PlaceAutocompleteActivity::class.java))</span>
<span class="nc" id="L66">        }</span>
<span class="nc" id="L67">    }</span>

    override fun onResume() {
<span class="nc" id="L70">        super.onResume()</span>
<span class="nc" id="L71">        requestCurrentLocation()</span>
<span class="nc" id="L72">    }</span>

    private fun initObservers() {
<span class="nc" id="L75">        lifecycleScope.launchWhenStarted {</span>
<span class="nc" id="L76">            viewModel.uiState.collect { state -&gt;</span>
                when (state) {
                    MainContract.MainState.Initial -&gt; {

                    }
                    is MainContract.MainState.Error -&gt; {
                        binding.progressBar.visibility = View.GONE
                        handleError(state.failure)
                    }
                    MainContract.MainState.Loading -&gt; {
                        binding.progressBar.visibility = View.VISIBLE
                        binding.container.visibility = View.GONE
                    }
                    is MainContract.MainState.Success -&gt; {
                        println(&quot;Success:${state.value}&quot;)
                        handleSuccess(state.value)
                    }
                }
            }

<span class="nc" id="L96">        }</span>
<span class="nc" id="L97">    }</span>

    @SuppressLint(&quot;SetTextI18n&quot;)
    private fun handleSuccess(value: WeatherUiModel) {
<span class="nc" id="L101">        val color = value.currentWeatherUIModel.type.getColor()</span>
<span class="nc" id="L102">        binding.progressBar.visibility = View.GONE</span>
<span class="nc" id="L103">        binding.container.visibility = View.VISIBLE</span>
<span class="nc" id="L104">        binding.container.setBackgroundColor(color)</span>
<span class="nc" id="L105">        value.currentWeatherUIModel.apply {</span>

<span class="nc" id="L107">            binding.currentTempBig.text = this.temp.toString().withDegree()</span>
<span class="nc" id="L108">            binding.currentWeatherType.text = this.type.name</span>
<span class="nc" id="L109">            binding.currentBigImage.setImageResource(this.type.getImage())</span>
<span class="nc" id="L110">            binding.minTemp.text = this.tempMin.toString().withDegree()</span>
<span class="nc" id="L111">            binding.currentTemp.text = this.temp.toString().withDegree()</span>
<span class="nc" id="L112">            binding.maxTemp.text = this.tempMax.toString().withDegree()</span>
<span class="nc" id="L113">        }</span>

<span class="nc" id="L115">        binding.forecasts.layoutManager = LinearLayoutManager(requireActivity().applicationContext)</span>
        binding.forecasts.adapter =
<span class="nc" id="L117">            ForecastAdapter(value.forecastWeatherUIModel.slice(1 until value.forecastWeatherUIModel.size))</span>

<span class="nc" id="L119">    }</span>

    private fun handleError(failure: Failure) {
<span class="nc" id="L122">        when (failure) {</span>
<span class="nc bnc" id="L123" title="All 2 branches missed.">            Failure.LocationIsDisabledError -&gt; {</span>
<span class="nc" id="L124">                showLocationSettings()</span>
            }

<span class="nc bnc" id="L127" title="All 2 branches missed.">            Failure.NetworkError -&gt; {</span>

            }
<span class="nc bnc" id="L130" title="All 2 branches missed.">            Failure.UnknownError -&gt; {</span>

            }
<span class="nc bnc" id="L133" title="All 2 branches missed.">            Failure.FineLocationPermissionNotGrantedError -&gt; {</span>
<span class="nc" id="L134">                requestPermissionWithRationale(</span>
<span class="nc" id="L135">                    Manifest.permission.ACCESS_FINE_LOCATION,</span>
<span class="nc" id="L136">                    REQUEST_FINE_LOCATION_PERMISSIONS_REQUEST_CODE,</span>
<span class="nc" id="L137">                    fineLocationRationalDialog</span>
                )
            }
        }
<span class="nc" id="L141">    }</span>

    override fun onDestroyView() {
<span class="nc" id="L144">        super.onDestroyView()</span>
<span class="nc" id="L145">        _binding = null</span>
<span class="nc" id="L146">    }</span>

<span class="nc" id="L148">    private val fineLocationRationalDialog by lazy {</span>
<span class="nc" id="L149">           AlertDialog.Builder(requireContext(), AlertDialog.THEME_DEVICE_DEFAULT_LIGHT)</span>
<span class="nc" id="L150">            .setMessage(getString(R.string.fine_location_permission_rationale))</span>
<span class="nc" id="L151">            .setCancelable(false)</span>
<span class="nc" id="L152">            .setPositiveButton(</span>
<span class="nc" id="L153">                getString(R.string.ok)</span>
<span class="nc" id="L154">            ) { _, _ -&gt;</span>
<span class="nc" id="L155">                viewModel.setIntent(MainContract.MainIntent.CloseDialog)</span>
<span class="nc" id="L156">                requestPermissions(</span>
<span class="nc" id="L157">                    arrayOf(Manifest.permission.ACCESS_FINE_LOCATION),</span>
<span class="nc" id="L158">                    REQUEST_FINE_LOCATION_PERMISSIONS_REQUEST_CODE</span>
                )

<span class="nc" id="L161">            }</span>
<span class="nc" id="L162">            .setNegativeButton(android.R.string.cancel) { _, _ -&gt;</span>
<span class="nc" id="L163">                viewModel.setIntent(MainContract.MainIntent.InitialIntent)</span>
<span class="nc" id="L164">            }</span>
    }

    override fun onRequestPermissionsResult(
        requestCode: Int,
        permissions: Array&lt;String&gt;,
        grantResults: IntArray
    ) {
<span class="nc" id="L172">        Log.d(TAG, &quot;onRequestPermissionResult()&quot;)</span>

<span class="nc bnc" id="L174" title="All 2 branches missed.">        if (requestCode == REQUEST_FINE_LOCATION_PERMISSIONS_REQUEST_CODE) {</span>
<span class="nc" id="L175">            when {</span>
<span class="nc bnc" id="L176" title="All 4 branches missed.">                grantResults.isEmpty() -&gt;</span>
                    // If user interaction was interrupted, the permission request
                    // is cancelled and you receive an empty array.
<span class="nc" id="L179">                    Log.d(TAG, &quot;User interaction was cancelled.&quot;)</span>

<span class="nc bnc" id="L181" title="All 2 branches missed.">                grantResults[0] == PackageManager.PERMISSION_GRANTED -&gt; {</span>
<span class="nc" id="L182">                    requestCurrentLocation()</span>
                }

                else -&gt; {
                   /* Snackbar.make(
                        binding.container,
                        R.string.fine_permission_denied_explanation,
                        Snackbar.LENGTH_INDEFINITE
                    ).setBackgroundTint(resources.getColor(android.R.color.white))
                        .setAction(R.string.settings) {
                            // Build intent that displays the App settings screen.
                            val intent = Intent()
                            intent.action = Settings.ACTION_APPLICATION_DETAILS_SETTINGS
                            val uri = Uri.fromParts(
                                &quot;package&quot;,
                                BuildConfig.APPLICATION_ID,
                                null
                            )
                            intent.data = uri
                            intent.flags = Intent.FLAG_ACTIVITY_NEW_TASK
                            startActivity(intent)
                        }
                        .show()*/
                }
            }
        }
<span class="nc" id="L208">    }</span>

    private fun showLocationSettings() {
<span class="nc" id="L211">        AlertDialog.Builder(requireContext(), AlertDialog.THEME_DEVICE_DEFAULT_LIGHT)</span>
<span class="nc" id="L212">            .setMessage(getString(R.string.enable_gps))</span>
<span class="nc" id="L213">            .setCancelable(false)</span>
<span class="nc" id="L214">            .setPositiveButton(</span>
<span class="nc" id="L215">                getString(R.string.settings)</span>
<span class="nc" id="L216">            ) { _, _ -&gt;</span>
<span class="nc" id="L217">                viewModel.setIntent(MainContract.MainIntent.CloseDialog)</span>
<span class="nc" id="L218">                startActivity(</span>
<span class="nc" id="L219">                    Intent(</span>
<span class="nc" id="L220">                        Settings.ACTION_LOCATION_SOURCE_SETTINGS</span>
                    )
                )
<span class="nc" id="L223">            }</span>
<span class="nc" id="L224">            .setNegativeButton(android.R.string.cancel) { _, _ -&gt;</span>
<span class="nc" id="L225">                viewModel.setIntent(MainContract.MainIntent.InitialIntent)</span>
<span class="nc" id="L226">            }</span>
<span class="nc" id="L227">            .show()</span>
<span class="nc" id="L228">    }</span>


    private fun requestCurrentLocation() {
<span class="nc bnc" id="L232" title="All 8 branches missed.">        if ((requireActivity().intent.extras?.getString(FavouriteUiModelID) ?: &quot;&quot;).isEmpty()) {</span>
<span class="nc" id="L233">            viewModel.setIntent(MainContract.MainIntent.InitialIntent)</span>
        } else {

<span class="nc" id="L236">            viewModel.setIntent(</span>
<span class="nc" id="L237">                MainContract.MainIntent.LoadFavoriteWeather(</span>
<span class="nc bnc" id="L238" title="All 2 branches missed.">                    requireActivity().intent.extras?.getDouble(FavouriteUiModelLat),</span>
<span class="nc bnc" id="L239" title="All 2 branches missed.">                    requireActivity().intent.extras?.getDouble(FavouriteUiModelLong)</span>
                )
            )
        }

<span class="nc" id="L244">    }</span>


    companion object {
        private const val TAG = &quot;MainActivity&quot;
        private const val REQUEST_FINE_LOCATION_PERMISSIONS_REQUEST_CODE = 34
    }

    private fun WeatherType.getColor(): Int {
<span class="nc bnc" id="L253" title="All 4 branches missed.">        return when (this) {</span>
<span class="nc" id="L254">            WeatherType.RAINY -&gt; ContextCompat.getColor(requireContext(), R.color.rainy)</span>
<span class="nc" id="L255">            WeatherType.CLOUDY -&gt; ContextCompat.getColor(requireContext(), R.color.cloudy)</span>
<span class="nc" id="L256">            WeatherType.SUNNY -&gt; ContextCompat.getColor(requireContext(), R.color.sunny)</span>
            else -&gt; {
<span class="nc" id="L258">                ContextCompat.getColor(requireContext(), R.color.sunny)</span>
            }
        }
    }

    private fun WeatherType.getImage(): Int {
<span class="nc bnc" id="L264" title="All 4 branches missed.">        return when (this) {</span>
<span class="nc" id="L265">            WeatherType.RAINY -&gt; R.drawable.forest_rainy</span>
<span class="nc" id="L266">            WeatherType.CLOUDY -&gt; R.drawable.forest_cloudy</span>
<span class="nc" id="L267">            WeatherType.SUNNY -&gt; R.drawable.forest_sunny</span>
            else -&gt; {
<span class="nc" id="L269">                R.drawable.forest_sunny</span>
            }
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>